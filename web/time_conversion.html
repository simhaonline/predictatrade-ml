<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Time Conversion & Session Normalization</title>
  <meta name="description" content="A clean tool for viewing trading session windows and normalizing server timestamps across timezones." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --border: #30363d;
      --primary: #58a6ff;
      --success: #3fb950;
      --error: #f85149;
      --radius: 12px;
      --shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .container {
      width: 100%;
      max-width: 1280px;
      background: var(--surface);
      border-radius: var(--radius);
      padding: 2.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 2.5rem;
      text-align: center;
      background: linear-gradient(90deg, #58a6ff, #1f6feb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    h2 {
      font-size: 1.35rem;
      font-weight: 600;
      margin: 3rem 0 1.25rem;
      color: var(--primary);
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: end;
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    label span {
      margin-bottom: 0.4rem;
      font-weight: 500;
    }

    input {
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
      transition: border 0.2s, box-shadow 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    button:hover {
      background: #1f6feb;
      transform: translateY(-1px);
    }

    button:active { transform: translateY(0); }

    .status {
      margin: 1rem 0;
      padding: 0.75rem 1rem;
      background: rgba(88, 166, 255, 0.1);
      border-radius: 8px;
      font-family: 'JetBrains Mono', ui-monospace, monospace;
      font-size: 0.95rem;
      color: var(--primary);
    }

    .status.error {
      color: var(--error);
      background: rgba(248, 81, 73, 0.1);
    }

    /* ========= TABLE FIX ========= */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
    }

    table {
      width: 100%;
      min-width: 1150px;
      border-collapse: separate;
      border-spacing: 0;
    }

    th, td {
      padding: 1rem;
      text-align: left;
      white-space: nowrap; /* ← never break timestamps */
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(88, 166, 255, 0.15);
      border-bottom: 2px solid var(--border);
      z-index: 10;
      color: var(--primary);
      font-weight: 600;
    }

    td:nth-child(n+3),
    th:nth-child(n+3) {
      font-family: 'JetBrains Mono', ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 0.875rem;
      letter-spacing: -0.02em;
    }

    tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    tr:hover { background: rgba(88, 166, 255, 0.1); }

    .log {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      font-family: 'JetBrains Mono', ui-monospace, monospace;
      font-size: 0.95rem;
      white-space: pre-wrap;
      max-height: 500px;
      overflow: auto;
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .container { padding: 1.5rem; }
      .controls { grid-template-columns: 1fr; }
      th, td { padding: 0.75rem 0.5rem; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Time Conversion &amp; Session Normalization</h1>

    <h2>1. Session Windows for a Trading Date</h2>
    <div class="controls">
      <label><span>Date</span>
        <input type="date" id="gridDateInput">
      </label>
      <label><span>Server TZ</span>
        <input type="text" id="gridServerTzInput" value="Etc/GMT-2" placeholder="e.g. America/New_York">
      </label>
      <button id="gridBtn">Generate Session Grid</button>
    </div>
    <p id="gridStatus" class="status"></p>

    <div class="table-wrapper">
      <table id="gridTable">
        <thead>
          <tr>
            <th>Session</th>
            <th>Session TZ</th>
            <th>Local Start</th>
            <th>Local End</th>
            <th>UTC Start</th>
            <th>UTC End</th>
            <th>Server TZ</th>
            <th>Server Start</th>
            <th>Server End</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>2. Normalize a Single Server Timestamp</h2>
    <div class="controls">
      <label><span>Trading Date</span>
        <input type="date" id="normDateInput">
      </label>
      <label><span>Server TZ</span>
        <input type="text" id="normServerTzInput" value="Etc/GMT-2">
      </label>
      <label><span>Server Time</span>
        <input type="text" id="normServerTimeInput" placeholder="YYYY-MM-DD HH:MM">
      </label>
      <button id="normBtn">Normalize</button>
    </div>
    <pre id="normOutput" class="log"></pre>
  </div>

  <!-- Your original JavaScript – 100 % untouched -->
  <script>
    function toISODateInput(d){return d.toISOString().slice(0,10);}
    document.addEventListener("DOMContentLoaded",()=>{
      const today = new Date();
      document.getElementById("gridDateInput").value = toISODateInput(today);
      document.getElementById("normDateInput").value = toISODateInput(today);
      document.getElementById("gridBtn").addEventListener("click", loadGrid);
      document.getElementById("normBtn").addEventListener("click", normalizeTime);
      loadGrid();
    });

    async function loadGrid(){
      const date = document.getElementById("gridDateInput").value;
      const serverTz = document.getElementById("gridServerTzInput").value || "Etc/GMT-2";
      const status = document.getElementById("gridStatus");
      const tbody = document.querySelector("#gridTable tbody");
      tbody.innerHTML = "";
      status.textContent = "Loading...";

      try{
        const url = `/api/sessions/grid?date_str=${encodeURIComponent(date)}&server_tz=${encodeURIComponent(serverTz)}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        let count = 0;
        for(const s of data.sessions){
          count++;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.session}</td>
            <td>${s.session_tz}</td>
            <td>${s.local_start}</td>
            <td>${s.local_end}</td>
            <td>${s.utc_start}</td>
            <td>${s.utc_end}</td>
            <td>${s.server_tz}</td>
            <td>${s.server_start}</td>
            <td>${s.server_end}</td>
          `;
          tbody.appendChild(tr);
        }
        status.textContent = `Loaded ${count} sessions for ${data.date} (server TZ ${data.server_tz}).`;
        status.classList.remove("error");
      }catch(err){
        console.error(err);
        status.textContent = `Error loading timeline: ${err.message}`;
        status.classList.add("error");
      }
    }

    async function normalizeTime(){
      const tradingDate = document.getElementById("normDateInput").value;
      const serverTz = document.getElementById("normServerTzInput").value || "Etc/GMT-2";
      const serverTime = document.getElementById("normServerTimeInput").value;
      const out = document.getElementById("normOutput");
      out.textContent = "Normalizing...";

      try{
        const url = `/api/sessions/normalize?trading_date=${encodeURIComponent(tradingDate)}&server_tz=${encodeURIComponent(serverTz)}&server_time=${encodeURIComponent(serverTime)}`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        out.textContent = JSON.stringify(data, null, 2);
      }catch(err){
        console.error(err);
        out.textContent = `Error normalizing: ${err.message}`;
      }
    }
  </script>
</body>
</html>